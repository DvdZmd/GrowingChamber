<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pan & Tilt Control</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    h1 {
      text-align: center;
    }

    .main-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 40px;
    }

    .video-container {
      max-width: 600px;
      flex: 1;
    }

    .video-container img {
      width: 100%;
      border: 2px solid #ccc;
      border-radius: 8px;
    }

    .status-panel {
      flex: 1;
      min-width: 250px;
      max-width: 350px;
    }

    .status {
      margin: 20px 0;
    }

    .servo-control-buttons {
      margin-top: 15px;
      text-align: center;
    }

    button {
      padding: 10px 20px;
      margin: 5px;
      font-size: 16px;
    }

    input {
      padding: 10px;
      margin: 10px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h1>Pan & Tilt Control</h1>

  <div class="main-container">
    <!-- Left: Video Feed -->
    <div class="video-container">
      <h3>Live Video Feed</h3>
      <img id="videoFeed" alt="Live Video Feed" />
    </div>

    <!-- Right: Sensor + Servo Info -->
    <div class="status-panel">
      <!-- Sensor Data -->
      <div class="status">
        <h3>Sensor Readings</h3>
        <p>Temperature (DHT22): <span id="temperature_dht"></span>째C</p>
        <p>Humidity: <span id="humidity"></span>%</p>
        <p>Temperature (DS18B20): <span id="temperature_ds18b20"></span>째C</p>
        <p>Soil Moisture: <span id="soil_moisture"></span></p>
      </div>

      <!-- Servo Status & Controls -->
      <div class="status">
        <h3>Servo Positions</h3>
        <p>Pan: <span id="servo_pan_value">-</span>째</p>
        <p>Tilt: <span id="servo_tilt_value">-</span>째</p>

        <div class="servo-control-buttons">
          <div>
            <button id="btn-up">Up</button>
        </div>
          <div>
            <button id="btn-left">Left</button>
            <button id="btn-right">Right</button>
        </div>
          <div>
            <button id="btn-down">Down</button>
        </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const apiUrl = `${window.location.protocol}//${window.location.hostname}:5000`;
    let servo_pan = 90;
    let servo_tilt = 90;

    function updateServoDisplay() {
      document.getElementById("servo_pan_value").textContent = servo_pan;
      document.getElementById("servo_tilt_value").textContent = servo_tilt;
    }   

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function moveServo(pan, tilt) {
      servo_pan = Math.max(90, Math.min(160, pan));
      servo_tilt = Math.max(0, Math.min(180, tilt));

      console.log("servo_pan: "+ servo_pan)
      console.log("servo_tilt: "+ servo_tilt)

      try {
        const response = await fetch(`${apiUrl}/send_pan_tilt`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ pan: servo_pan, tilt: servo_tilt }),
        });


        await sleep(500);

        if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
            updateServoDisplay();

      } catch (error) {
        console.error("Error:", error);
      }
    }

    async function fetchSensorData() {
      try {
        const response = await fetch(`${apiUrl}/get_sensors`);
        if (!response.ok) 
            throw new Error(`HTTP error: ${response.status}`);
        const data = await response.json();
        document.getElementById("temperature_dht").textContent = data.temperature_dht;
        document.getElementById("humidity").textContent = data.humidity;
        document.getElementById("temperature_ds18b20").textContent = data.temperature_ds18b20;
        document.getElementById("soil_moisture").textContent = data.soil_moisture;
      } catch (error) {
        console.error("Error fetching sensor data:", error);
      }
    }

    async function fetchServoPosition() {
      try {
        const response = await fetch(`${apiUrl}/request_current_pan_tilt`);
        if (!response.ok) 
            throw new Error(`HTTP error: ${response.status}`);
        const data = await response.json();
        servo_pan = data.pan;
        servo_tilt = data.tilt;
        updateServoDisplay();

      } catch (error) {
        console.error("Error fetching servo position:", error);
      }
    }

    window.onload = () => {
        document.getElementById("btn-up").addEventListener("click", () => {
            moveServo(servo_pan - 5, servo_tilt);
        });
        document.getElementById("btn-down").addEventListener("click", () => {
            moveServo(servo_pan + 5, servo_tilt);
        });
        document.getElementById("btn-left").addEventListener("click", () => {
            moveServo(servo_pan, servo_tilt + 5);
        });
        document.getElementById("btn-right").addEventListener("click", () => {
            moveServo(servo_pan, servo_tilt - 5);
        });

      document.getElementById("videoFeed").src = `${apiUrl}/video_feed`;
    };

    setInterval(fetchSensorData, 500);
    setInterval(fetchServoPosition, 500);

  </script>
</body>
</html>
